version: '3.8'

services:
  # MySQL 数据库服务
  mysql:
    image: mysql:8.0
    container_name: warm_shop_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: StrongPassword123!  # 生产环境请修改
      MYSQL_DATABASE: warm_shop                # 自动创建数据库
      MYSQL_USER: warm_shop_user               # 应用专用用户
      MYSQL_PASSWORD: ShopUser123!             # 生产环境请修改
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql              # 数据持久化
      - ./sql/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql  # 初始化脚本
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - warm_shop_network

  # Django 后端服务
  backend:
    build: .
    container_name: warm_shop_backend
    restart: always
    depends_on:
      - mysql  # 等待 MySQL 启动后再启动
    environment:
      # Django 环境变量配置
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: "django-insecure-89$7&z=^%6@8x!09s7^&*()_+lkjhgfdsazxcvbnm"
      # 数据库连接配置
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: warm_shop
      DB_USER: warm_shop_user
      DB_PASSWORD: ShopUser123!
    ports:
      - "8000:8000"
    volumes:
      - ./media:/app/media          # 媒体文件持久化
      - ./staticfiles:/app/staticfiles  # 静态文件持久化
      - ./logs:/app/logs            # 日志持久化
    networks:
      - warm_shop_network

# 数据卷：持久化 MySQL 数据和项目文件
volumes:
  mysql_data:

# 自定义网络：容器间通信
networks:
  warm_shop_network:
    driver: bridge